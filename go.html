<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å°å°å›´æ£‹ - AI æ™ºèƒ½è¯†è°±</title>
    <style>
        :root {
            --board-color: #dec08a;
            --primary: #2c3e50;
            --accent: #e67e22;
        }

        body {
            margin: 0; padding: 0;
            background-color: #f5f5f5;
            font-family: 'PingFang SC', sans-serif;
            display: flex; flex-direction: column; align-items: center;
        }

        header {
            width: 100%; padding: 15px;
            background: var(--primary);
            color: white; text-align: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
        }

        #main-container {
            width: 100%; max-width: 500px;
            padding: 10px; box-sizing: border-box;
        }

        /* æ£‹ç›˜å®¹å™¨ */
        #board-wrapper {
            position: relative;
            width: 100%; padding-top: 100%;
            background-color: var(--board-color);
            box-shadow: 0 5px 20px rgba(0,0,0,0.2);
            border-radius: 4px;
            overflow: hidden;
        }

        #go-canvas {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
        }

        /* æ§åˆ¶é¢æ¿ */
        .controls {
            margin-top: 20px;
            display: grid; grid-template-columns: 1fr 1fr; gap: 10px;
        }

        .btn {
            padding: 12px; border: none; border-radius: 8px;
            background: white; color: var(--primary);
            font-size: 14px; font-weight: bold;
            cursor: pointer; box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            transition: all 0.2s;
            display: flex; align-items: center; justify-content: center;
            gap: 8px;
        }

        .btn:active { transform: scale(0.95); }
        .btn.primary { background: var(--primary); color: white; }
        .btn.accent { background: var(--accent); color: white; }

        .result-panel {
            margin-top: 20px;
            background: white; padding: 15px;
            border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }

        .score-row {
            display: flex; justify-content: space-between;
            margin: 5px 0; font-size: 1.1rem;
        }

        .black-text { color: #000; font-weight: bold; }
        .white-text { color: #888; font-weight: bold; }

        #upload-input { display: none; }

        .loading-overlay {
            position: fixed; inset: 0; background: rgba(0,0,0,0.7);
            display: none; flex-direction: column; align-items: center; justify-content: center;
            color: white; z-index: 1000;
        }
        
        .spinner {
            width: 40px; height: 40px; border: 4px solid #f3f3f3;
            border-top: 4px solid var(--accent); border-radius: 50%;
            animation: spin 1s linear infinite; margin-bottom: 15px;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

<header>
    <h2>å°å°å›´æ£‹è¯†è°± âœ¨</h2>
</header>

<div id="main-container">
    <div id="board-wrapper">
        <canvas id="go-canvas"></canvas>
    </div>

    <div class="result-panel">
        <div class="score-row">
            <span>é»‘æ£‹ï¼š<span id="black-score" class="black-text">0</span> å­</span>
            <span>ç™½æ£‹ï¼š<span id="white-score" class="white-text">0</span> å­</span>
        </div>
        <div id="winner-msg" style="text-align: center; margin-top: 10px; font-weight: bold; color: var(--accent);">
            ç­‰å¾…è¯†åˆ«...
        </div>
    </div>

    <div class="controls">
        <button class="btn primary" onclick="document.getElementById('upload-input').click()">
            ğŸ“· ä¸Šä¼ ç…§ç‰‡
        </button>
        <button class="btn accent" onclick="calculateScore()">
            ğŸ§® é‡æ–°è®¡ç®—
        </button>
        <button class="btn" onclick="resetBoard()">
            ğŸ”„ æ¸…ç©ºæ£‹ç›˜
        </button>
        <button class="btn" onclick="toggleEditMode()" id="edit-btn">
            âœï¸ ç¼–è¾‘æ¨¡å¼: å…³
        </button>
    </div>
    <input type="file" id="upload-input" accept="image/*">
</div>

<div class="loading-overlay" id="loading">
    <div class="spinner"></div>
    <div id="loading-text">AI æ­£åœ¨è¯†åˆ«æ£‹è°±...</div>
</div>

<script>
    const canvas = document.getElementById('go-canvas');
    const ctx = canvas.getContext('2d');
    const uploadInput = document.getElementById('upload-input');
    const loading = document.getElementById('loading');

    const GRID_SIZE = 19;
    let cellSize = 0;
    let padding = 0;
    
    // æ£‹ç›˜æ•°æ®ï¼š0-ç©ºï¼Œ1-é»‘ï¼Œ2-ç™½
    let board = Array(GRID_SIZE).fill().map(() => Array(GRID_SIZE).fill(0));
    let editMode = false;
    let currentStone = 1; // é»˜è®¤æ”¾é»‘å­

    function initCanvas() {
        const size = canvas.parentElement.offsetWidth;
        canvas.width = size * window.devicePixelRatio;
        canvas.height = size * window.devicePixelRatio;
        ctx.scale(window.devicePixelRatio, window.devicePixelRatio);
        
        padding = size * 0.05;
        cellSize = (size - padding * 2) / (GRID_SIZE - 1);
        drawBoard();
    }

    function drawBoard() {
        const size = canvas.width / window.devicePixelRatio;
        ctx.clearRect(0, 0, size, size);

        // ç»˜åˆ¶çº¿æ¡
        ctx.strokeStyle = '#333';
        ctx.lineWidth = 1;
        for (let i = 0; i < GRID_SIZE; i++) {
            // æ¨ªçº¿
            ctx.beginPath();
            ctx.moveTo(padding, padding + i * cellSize);
            ctx.lineTo(size - padding, padding + i * cellSize);
            ctx.stroke();
            // çºµçº¿
            ctx.beginPath();
            ctx.moveTo(padding + i * cellSize, padding);
            ctx.lineTo(padding + i * cellSize, size - padding);
            ctx.stroke();
        }

        // ç»˜åˆ¶æ˜Ÿä½
        const stars = [3, 9, 15];
        ctx.fillStyle = '#333';
        stars.forEach(r => {
            stars.forEach(c => {
                ctx.beginPath();
                ctx.arc(padding + c * cellSize, padding + r * cellSize, 3, 0, Math.PI * 2);
                ctx.fill();
            });
        });

        // ç»˜åˆ¶æ£‹å­
        for (let r = 0; r < GRID_SIZE; r++) {
            for (let c = 0; c < GRID_SIZE; c++) {
                if (board[r][c] !== 0) {
                    drawStone(r, c, board[r][c]);
                }
            }
        }
    }

    function drawStone(r, c, type) {
        const x = padding + c * cellSize;
        const y = padding + r * cellSize;
        const rad = cellSize * 0.45;

        ctx.beginPath();
        ctx.arc(x, y, rad, 0, Math.PI * 2);
        
        if (type === 1) { // é»‘å­
            const grad = ctx.createRadialGradient(x-rad/3, y-rad/3, rad/10, x, y, rad);
            grad.addColorStop(0, '#666');
            grad.addColorStop(1, '#000');
            ctx.fillStyle = grad;
        } else { // ç™½å­
            const grad = ctx.createRadialGradient(x-rad/3, y-rad/3, rad/10, x, y, rad);
            grad.addColorStop(0, '#fff');
            grad.addColorStop(1, '#ccc');
            ctx.fillStyle = grad;
            ctx.strokeStyle = '#999';
            ctx.lineWidth = 1;
            ctx.stroke();
        }
        ctx.fill();
    }

    // ç®€æ˜“æ•°å­ç®—æ³•ï¼ˆä¸­å›½è§„åˆ™æ ¸å¿ƒï¼šå­ç©ºçš†åœ°ï¼‰
    function calculateScore() {
        let black = 0;
        let white = 0;
        
        // 1. å…ˆæ•°æ£‹ç›˜ä¸Šçš„æ´»å­
        for(let r=0; r<GRID_SIZE; r++) {
            for(let c=0; c<GRID_SIZE; c++) {
                if(board[r][c] === 1) black++;
                if(board[r][c] === 2) white++;
            }
        }

        // 2. ç®€å•çš„é¢†åœ°è®¡ç®—ï¼ˆæ´ªæ°´å¡«å……ï¼‰
        const visited = Array(GRID_SIZE).fill().map(() => Array(GRID_SIZE).fill(false));
        for(let r=0; r<GRID_SIZE; r++) {
            for(let c=0; c<GRID_SIZE; c++) {
                if(board[r][c] === 0 && !visited[r][c]) {
                    const area = [];
                    const result = floodFill(r, c, visited, area);
                    if(result === 1) black += area.length;
                    if(result === 2) white += area.length;
                }
            }
        }

        document.getElementById('black-score').innerText = black;
        document.getElementById('white-score').innerText = white;
        
        const komi = 7.5; // ä¸­å›½è§„åˆ™è´´ç›®
        const diff = black - (GRID_SIZE * GRID_SIZE / 2 + komi / 2);
        
        if (black > 184.25) {
            document.getElementById('winner-msg').innerText = `é»‘æ£‹èƒœï¼(é¢†å…ˆ ${ (black - 184.25).toFixed(2) } å­)`;
        } else {
            document.getElementById('winner-msg').innerText = `ç™½æ£‹èƒœï¼(é¢†å…ˆ ${ (184.25 - black).toFixed(2) } å­)`;
        }
    }

    function floodFill(r, c, visited, area) {
        const stack = [[r, c]];
        let owner = null; // 0-æ··åˆ, 1-é»‘, 2-ç™½
        let touchBlack = false;
        let touchWhite = false;

        while(stack.length > 0) {
            const [currR, currC] = stack.pop();
            if(currR < 0 || currR >= GRID_SIZE || currC < 0 || currC >= GRID_SIZE) continue;
            if(visited[currR][currC]) continue;
            
            if(board[currR][currC] === 0) {
                visited[currR][currC] = true;
                area.push([currR, currC]);
                stack.push([currR-1, currC], [currR+1, currC], [currR, currC-1], [currR, currC+1]);
            } else if(board[currR][currC] === 1) {
                touchBlack = true;
            } else if(board[currR][currC] === 2) {
                touchWhite = true;
            }
        }

        if(touchBlack && !touchWhite) return 1;
        if(touchWhite && !touchBlack) return 2;
        return 0;
    }

    function resetBoard() {
        board = Array(GRID_SIZE).fill().map(() => Array(GRID_SIZE).fill(0));
        drawBoard();
        document.getElementById('winner-msg').innerText = "ç­‰å¾…è¯†åˆ«...";
    }

    function toggleEditMode() {
        editMode = !editMode;
        document.getElementById('edit-btn').innerText = `âœï¸ ç¼–è¾‘æ¨¡å¼: ${editMode ? 'é»‘' : 'å…³'}`;
        if(editMode) currentStone = 1;
    }

    // ç‚¹å‡»äº¤äº’
    canvas.addEventListener('click', (e) => {
        if(!editMode) return;
        
        const rect = canvas.getBoundingClientRect();
        const x = (e.clientX - rect.left) * (canvas.width / rect.width / window.devicePixelRatio);
        const y = (e.clientY - rect.top) * (canvas.height / rect.height / window.devicePixelRatio);

        const c = Math.round((x - padding) / cellSize);
        const r = Math.round((y - padding) / cellSize);

        if(r >= 0 && r < GRID_SIZE && c >= 0 && c < GRID_SIZE) {
            if(board[r][c] === currentStone) {
                board[r][c] = 0; // å†æ¬¡ç‚¹å‡»å–æ¶ˆ
            } else {
                board[r][c] = currentStone;
            }
            drawBoard();
            calculateScore();
            // åˆ‡æ¢æ£‹å­é¢œè‰²
            currentStone = board[r][c] === 0 ? currentStone : (currentStone === 1 ? 2 : 1);
            document.getElementById('edit-btn').innerText = `âœï¸ ç¼–è¾‘æ¨¡å¼: ${currentStone === 1 ? 'é»‘' : 'ç™½'}`;
        }
    });

    // æ¨¡æ‹Ÿè¯†åˆ«é€»è¾‘ï¼ˆä½ éœ€è¦ä¸Šä¼ å›¾ç‰‡ï¼Œæˆ‘æ¥è°ƒç”¨ python å¤„ç†ï¼‰
    uploadInput.addEventListener('change', function(e) {
        if(!e.target.files[0]) return;
        loading.style.display = 'flex';
        
        // æ­¤å¤„åº”å°†å›¾ç‰‡å‘é€ç»™â€œå°å°â€ï¼Œç”±äºæ˜¯ H5 æ¼”ç¤ºï¼Œæˆ‘å°†æç¤ºç”¨æˆ·åœ¨èŠå¤©çª—å£å‘é€å›¾ç‰‡
        setTimeout(() => {
            loading.style.display = 'none';
            alert("è¯·åœ¨å¯¹è¯æ¡†ä¸­å°†è¿™å¼ å›´æ£‹ç…§ç‰‡å‘é€ç»™æˆ‘ï¼ˆå°å°ï¼‰ï¼Œæˆ‘ä¼šåˆ†ææ£‹å±€å¹¶ä¸ºä½ åŒæ­¥åˆ°è¿™ä¸ªæ£‹ç›˜ä¸­ï¼");
        }, 1500);
    });

    window.addEventListener('resize', initCanvas);
    window.onload = initCanvas;
</script>
</body>
</html>
